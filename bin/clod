#!/bin/env bash
set -euo pipefail

CLOD_VERSION="0.2.8"

reinit=${CLOD_REINIT:-false}
noninteractive=${CLOD_NONINTERACTIVE:-false}
config=${CLOD_CONFIG:-$HOME/.claude.json}

# Compute hash of all files in .clod directory (not subdirectories)
compute_clod_hash() {
  # Hash all regular files in .clod (excluding subdirs like claude/)
  # Sort for consistency, exclude the hash file itself
  find .clod -maxdepth 1 -type f ! -name '.hash' -print0 2>/dev/null \
    | sort -z \
    | xargs -0 sha256sum 2>/dev/null \
    | sha256sum \
    | cut -d' ' -f1
}

changes_detected() {
  local stored_hash=''
  if [[ -f .clod/.hash ]]; then
    local stored_hash=$(<.clod/.hash)
  fi

  local current_hash=$(compute_clod_hash)

  if [[ "$stored_hash" == "$current_hash" ]]; then
    return 1
  fi

  return 0
}

save_hash() {
  compute_clod_hash > .clod/.hash
}

# Compare semantic versions. Returns 0 if $1 > $2, 1 otherwise.
version_gt() {
  local v1=$1 v2=$2
  if [[ "$v1" == "$v2" ]]; then
    return 1
  fi
  local IFS=.
  local i v1_parts=($v1) v2_parts=($v2)
  for ((i=0; i<${#v1_parts[@]}; i++)); do
    local n1=${v1_parts[i]:-0}
    local n2=${v2_parts[i]:-0}
    if ((n1 > n2)); then
      return 0
    elif ((n1 < n2)); then
      return 1
    fi
  done
  return 1
}

# Is this directory initialized?
initialize() {
  mkdir -p .clod/claude

  # Use an existing config if available.
  if [[ ! -f .clod/claude/claude.json && -f "$config" ]]; then
    cp "$config" .clod/claude/claude.json
  fi

  local cwd=$(pwd)

  if [[ ! -f .clod/name ]]; then
    local name=$(basename "$cwd")
    printf '%s\n' "$name" > .clod/name
  else
    local name=$(<.clod/name)
  fi

  # Create a unique id for this directory so that
  # we can have a short name.
  if [[ ! -f .clod/id ]]; then
    local uuid=$(uuidgen)
    local id=${uuid:0:8}
    printf '%s\n' "$id" > .clod/id
  else
    local id=$(<.clod/id)
  fi

  if [[ ! -f .clod/image ]]; then
    printf '%s\n' "${CLOD_IMAGE:-ubuntu:24.04}" > .clod/image
  fi
  local image=$(<.clod/image)


  cat <<EOF > .clod/Dockerfile_base
FROM $image AS base

ARG DEBIAN_FRONTEND=noninteractive
RUN --mount=type=cache,sharing=locked,target=/var/cache/apt \\
    --mount=type=cache,sharing=locked,target=/var/lib/apt \\
    apt-get update \\
 && apt-get install -qq -y npm
EOF

  if [[ ! -f .clod/Dockerfile_project ]]; then
    cat <<EOF > .clod/Dockerfile_project
FROM base AS project

# Uncomment to add project specific dependencies.
#ARG DEBIAN_FRONTEND=noninteractive
#RUN --mount=type=cache,sharing=locked,target=/var/cache/apt \\
#    --mount=type=cache,sharing=locked,target=/var/lib/apt \\
#    apt-get update \\
# && apt-get install -qq -y npm
EOF
  fi

  cat <<EOF > .clod/Dockerfile_wrapper
FROM project AS wrapper

COPY <<DEOF /usr/bin/claude-wrapper
#!/bin/bash
set -euo pipefail

if [[ -f ~/.claude/claude.json ]]; then
  cp ~/.claude/claude.json ~/.claude.json
fi

trap 'cp ~/.claude.json ~/.claude/claude.json' EXIT

claude "\\\$@"
DEOF
RUN chmod u+x /usr/bin/claude-wrapper

ARG GROUP_ID
ARG GROUP_NAME
ARG USER_ID
ARG USER_NAME
RUN (groupdel \$(getent group "\$GROUP_ID" | cut -d: -f1) || true) \\
 && (userdel \$(getent passwd "\$USER_ID" | cut -d: -f1) || true) \\
 && groupadd -g "\$GROUP_ID" "\$GROUP_NAME" \\
 && useradd -m -u "\$USER_ID" -g "\$GROUP_NAME" "\$USER_NAME"

USER "\$USER_NAME"
WORKDIR "/home/\$USER_NAME"

RUN mkdir ~/.npm \\
 && npm config set prefix ~/.npm \\
 && npm install -g @anthropic-ai/claude-code
ENV PATH="\$PATH:/home/\$USER_NAME/bin:/home/\$USER_NAME/.npm/bin"

ENTRYPOINT ["claude-wrapper"]
EOF

  cat <<EOF > .clod/build
#!/bin/env bash
set -euo pipefail

name=\$(<.clod/name)
id=\$(<.clod/id)

# Who are you?
user_id=\$(id -u)
user_name=\$(id -nu)
group_id=\$(id -u)
group_name=\$(id -nu)

cat .clod/Dockerfile_base .clod/Dockerfile_project .clod/Dockerfile_wrapper > .clod/Dockerfile

exec docker build \\
  --build-arg "USER_ID=\$user_id" \\
  --build-arg "USER_NAME=\$user_name" \\
  --build-arg "GROUP_ID=\$group_id" \\
  --build-arg "GROUP_NAME=\$group_name" \\
  -t "clod-\${name,,}-\$id" \\
  -f .clod/Dockerfile \\
  .
EOF
  chmod u+x .clod/build

  cat <<EOF > .clod/run
#!/bin/env bash
set -euo pipefail

cwd=\$(pwd)
name=\$(<.clod/name)
id=\$(<.clod/id)
user_name=\$(id -nu)

if [[ -v CLOD_ENTRYPOINT ]]; then
  entrypoint="--entrypoint \$CLOD_ENTRYPOINT"
fi

if [[ -t 0 ]]; then
  tty_flag="-it"
fi

# Pass through MCP timeout if set (for permission prompts)
if [[ -v MCP_TOOL_TIMEOUT ]]; then
  mcp_env="-e MCP_TOOL_TIMEOUT=\$MCP_TOOL_TIMEOUT"
fi

# Determine default concurrency from .clod/concurrent file
concurrent_default="false"
if [[ -f .clod/concurrent ]]; then
  concurrent_file=\$(<.clod/concurrent)
  if [[ "\$concurrent_file" == "true" ]]; then
    concurrent_default="true"
  fi
fi

# Allow CLOD_CONCURRENT to override the default
concurrent="\${CLOD_CONCURRENT:-\$concurrent_default}"

# Generate unique suffix for concurrent mode
runtime_suffix=""
if [[ "\$concurrent" == "true" ]]; then
  # Use provided suffix or generate one
  if [[ -v CLOD_RUNTIME_SUFFIX ]]; then
    runtime_suffix="-\$CLOD_RUNTIME_SUFFIX"
  else
    # Generate 6 random hex characters
    runtime_suffix="-\$(head -c 3 /dev/urandom | xxd -p)"
  fi
fi

# Determine runtime directory and create it
runtime_dir=".clod/runtime\${runtime_suffix}"
mkdir -p "\$runtime_dir"

# Set up cleanup trap to remove runtime directory on exit
trap "rm -rf '\$runtime_dir'" EXIT

# Always name the container, adding suffix in concurrent mode
container_name="--name clod-\${name,,}-\$id\${runtime_suffix}"

docker run \${tty_flag:-} --rm \\
  \${container_name} \\
  --hostname "clod-\$name-\$id" \\
  -v "\$cwd:\$cwd" \\
  -v "\$cwd/.clod:\$cwd/.clod:ro" \\
  -v "\$cwd/\$runtime_dir:\$cwd/\$runtime_dir:rw" \\
  -v "\$cwd/.clod/claude:/home/\$user_name/.claude" \\
  -w "\$cwd" \\
  -e "CLOD_RUNTIME_DIR=\$runtime_dir" \\
  \${mcp_env:-} \\
  \${entrypoint:-} \\
  "clod-\${name,,}-\$id" "\$@"
EOF
  chmod u+x .clod/run

  # Store the version used to initialize
  printf '%s\n' "$CLOD_VERSION" > .clod/version
  save_hash
}

# Check if we need to initialize or upgrade
needs_init=false
needs_upgrade=false

if [[ ! -d .clod ]]; then
  needs_init=true
elif [[ $reinit == 'true' ]]; then
  needs_init=true
elif changes_detected; then
  printf 'Detected changes in .clod files, reinitializing...\n'
  needs_upgrade=true
elif [[ ! -f .clod/version ]]; then
  needs_upgrade=true
else
  installed_version=$(<.clod/version)
  if version_gt "$CLOD_VERSION" "$installed_version"; then
    needs_upgrade=true
  fi
fi

if [[ $needs_init == 'true' ]]; then
  if [[ $noninteractive == 'true' ]]; then
    printf 'ERROR: .clod directory not initialized. Run clod interactively first.\n' >&2
    exit 1
  fi
  read -p "Initialize the .clod directory? [Y/n] " yn
  case $yn in
    [Yy]* | '')
      printf 'Initializing clod v%s...\n' "$CLOD_VERSION"
      initialize
      ;;
    *)
      exit
      ;;
  esac
elif [[ $needs_upgrade == 'true' ]]; then
  installed_version=${installed_version:-"unknown"}
  printf 'Upgrading clod from v%s to v%s...\n' "$installed_version" "$CLOD_VERSION"
  initialize
fi


 # It's go time!
.clod/build
exec .clod/run "$@"
